<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –®–∞–±–∞—à–µ—Ä</title>

  <style>
    body {
      font-family: Inter, Roboto, sans-serif;
      background:#F7F7FB;
      margin:0;
      padding:20px;
      color:#111;
    }

    .card {
      max-width:720px;
      margin:32px auto;
      background:#fff;
      padding:24px;
      border-radius:20px;
      box-shadow:0 6px 20px rgba(0,0,0,0.06);
    }

    .title {
      font-size:22px;
      margin-bottom:6px;
      font-weight:700;
    }

    .sub { 
      color:#666; 
      margin-bottom:20px;
      font-size:16px;
    }

    .qr {
      display:flex;
      justify-content:center;
      margin:22px 0;
    }

    .btn {
      padding:14px 18px;
      border-radius:14px;
      border:none;
      cursor:pointer;
      font-weight:600;
      font-size:17px;
    }

    .btn.primary {
      background:#F09C00;
      color:#fff;
      width:100%;
    }

    .btn.download {
      background:#EDEDED;
      color:#111;
      width:100%;
      margin-top:12px;
    }

    .linkbox {
      margin-top:24px;
      display:flex;
      align-items:center;
      gap:8px;
      padding:12px;
      border-radius:14px;
      background:#F1F1F3;
    }

    .link {
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      width:100%;
    }

    .copy {
      border:none;
      background:none;
      cursor:pointer;
      font-size:20px;
    }
    
    /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .error {
      color: #ff4444;
      text-align: center;
      padding: 20px;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <div class="card" id="card">
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è...</div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç) -->
    <div id="content" class="hidden">
      <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ–±—ã—Ç–∏—è -->
      <div class="title" id="eventTitle">–í—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω—ã –≤ —Å–æ–±—ã—Ç–∏–µ üéâ</div>
      
      <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–±—ã—Ç–∏–∏ (–¥–∞—Ç–∞, –≤—Ä–µ–º—è, –∞–¥—Ä–µ—Å) -->
      <div class="sub" id="eventInfo"></div>

      <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è QR-–∫–æ–¥–∞ -->
      <div class="qr" id="qrContainer"></div>

      <!-- –ö–Ω–æ–ø–∫–∏ -->
      <button id="openAppBtn" class="btn primary">–û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>
      <button id="downloadBtn" class="btn download">–°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (APK)</button>

      <!-- –°—Å—ã–ª–∫–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è -->
      <div class="linkbox">
        <div class="link" id="linkText"></div>
        <button id="copyBtn" class="copy">üìã</button>
      </div>

      <div style="color:#888; font-size:13px; margin-top:8px;">
        –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ‚Äî –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω APK-—Ñ–∞–π–ª.
      </div>
    </div>
    
    <!-- –ë–ª–æ–∫ –æ—à–∏–±–∫–∏ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç) -->
    <div class="error hidden" id="error"></div>
  </div>

  <!-- QR library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
      // –ë–∞–∑–æ–≤—ã–π URL API: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–∫—É—â–∏–π origin (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏)
      // –ß—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä, –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–¥ —Å–∫—Ä–∏–ø—Ç–æ–º: <script>window.__API_ORIGIN__ = "https://shabasher.duckdns.org";
      const API_ORIGIN = (typeof window.__API_ORIGIN__ !== "undefined" && window.__API_ORIGIN__) ? window.__API_ORIGIN__.replace(/\/$/, "") : "";
      const APK_URL = API_ORIGIN + "/api/invites/download/shabasher-v0.1.apk";
      const API_BASE_URL = API_ORIGIN + "/api/invites";

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è inviteId –∏–∑ URL
      function getInviteIdFromPath() {
          // –ü—Ä–∏–º–µ—Ä: /api/invites/abc123 ‚Üí inviteId = abc123
          const pathSegments = window.location.pathname.split('/').filter(seg => seg);
          
          // –ò—â–µ–º inviteId (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç –≤ –ø—É—Ç–∏)
          if (pathSegments.length > 0) {
              return pathSegments[pathSegments.length - 1];
          }
          return null;
      }

      // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
      function formatDate(dateString) {
          try {
              const date = new Date(dateString);
              return date.toLocaleDateString('ru-RU', {
                  day: 'numeric',
                  month: 'long',
                  year: 'numeric'
              });
          } catch (e) {
              return dateString;
          }
      }

      // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
      function formatTime(timeString) {
          try {
              // –ï—Å–ª–∏ timeString –≤ —Ñ–æ—Ä–º–∞—Ç–µ "hh:mm:ss"
              const [hours, minutes] = timeString.split(':');
              return `${hours}:${minutes}`;
          } catch (e) {
              return timeString;
          }
      }

      // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
      async function loadInviteData() {
          const inviteId = getInviteIdFromPath();
          console.log('Invite ID –∏–∑ URL:', inviteId);

          if (!inviteId) {
              showError("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è");
              return;
          }

          try {
              // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –≤–∞—à–µ–≥–æ API
              console.log('–î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫:', `${API_BASE_URL}/${inviteId}/details`);
              const response = await fetch(`${API_BASE_URL}/${inviteId}/details`);

              if (!response.ok) {
                  if (response.status === 404) {
                      throw new Error('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                  } else if (response.status === 400) {
                      const errorText = await response.text();
                      throw new Error(errorText || '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–æ');
                  } else {
                      throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                  }
              }

              const data = await response.json();
              console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);

              // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
              const formattedDate = formatDate(data.startDate);
              const formattedTime = formatTime(data.startTime);

              // –û–±–Ω–æ–≤–ª—è–µ–º UI
              document.getElementById("eventTitle").textContent = data.name;
              document.getElementById("eventInfo").textContent = `${formattedDate} –≤ ${formattedTime} ‚Ä¢ ${data.address}`;
              document.getElementById("linkText").textContent = window.location.href;

              // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥ (–æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π, –µ—Å–ª–∏ –µ—Å—Ç—å)
              document.getElementById("qrContainer").innerHTML = "";
              new QRCode(document.getElementById("qrContainer"), {
                  text: window.location.href,
                  width: 220,
                  height: 220
              });

              // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏"
              document.getElementById("openAppBtn").onclick = function() {
                  openInApp(data.id);
              };

              // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–∫–∞—á–∞—Ç—å APK"
              document.getElementById("downloadBtn").onclick = function() {
                  window.location.href = APK_URL;
              };

              // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
              document.getElementById("copyBtn").onclick = async function() {
                  try {
                      await navigator.clipboard.writeText(window.location.href);
                      alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
                  } catch (err) {
                      console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                  }
              };

              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
              document.getElementById("loading").classList.add("hidden");
              document.getElementById("content").classList.remove("hidden");

          } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
              showError(error.message);
          }
      }

      // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
      function openInApp(eventId) {
          const deepLink = `shabasher://event?eventId=${eventId}`;
          const isAndroid = /android/i.test(navigator.userAgent);

          if (isAndroid) {
              // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
              window.location = deepLink;

              // –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ‚Üí —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫ —Å–∫–∞—á–∏–≤–∞–µ–º APK
              setTimeout(() => {
                  window.location = APK_URL;
              }, 1500);
          } else {
              // –ù–∞ iOS –Ω–µ—Ç APK ‚Üí –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º QR/—Å—Å—ã–ª–∫—É
              alert("–î–ª—è iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ App Store");
          }
      }

      // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
      function showError(message) {
          document.getElementById("loading").classList.add("hidden");
          document.getElementById("content").classList.add("hidden");
          document.getElementById("error").textContent = message;
          document.getElementById("error").classList.remove("hidden");
      }

      // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener('DOMContentLoaded', loadInviteData);
      
      // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: —Ç–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
          setTimeout(loadInviteData, 1);
      }
  </script>
</body>
</html>